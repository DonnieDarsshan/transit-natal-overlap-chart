<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Transit Mixer</title>
<style>
:root{
    --bg-gradient: linear-gradient(135deg,#1a001a,#2b0000);
    --grid-line:#ffcc00;
    --text-white:#ffffff;
    --asc-yellow:#ffcc00;
    --transit:#00e5ff;
}
body{
    background:var(--bg-gradient);
    color:var(--text-white);
    font-family:Arial,sans-serif;
    margin:0;
    padding:20px;
}
.controls{
    display:flex;
    gap:15px;
    justify-content:center;
    margin-bottom:25px;
}
button{
    padding:10px 20px;
    background:var(--grid-line);
    color:#000;
    border:none;
    font-weight:bold;
    cursor:pointer;
}
.kundali{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    grid-template-rows:repeat(4,1fr);
    width:650px;
    height:650px;
    margin:0 auto;
    border:2px solid var(--grid-line);
}
.house{
    border:1px solid var(--grid-line);
    position:relative;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
}
.house-num{
    position:absolute;
    top:4px;
    left:6px;
    color:var(--asc-yellow);
    font-weight:bold;
    font-size:18px;
}
.cusp-line{
    font-size:13px;
    color:#ffcc00;
    margin-bottom:4px;
}
.p-line{
    font-size:18px;
    margin:2px 0;
    font-weight:bold;
}
.asc-line{
    color:var(--asc-yellow);
    font-weight:bold;
}
.transit-line{
    color:var(--transit);
}




/* Dark theme for pivot dropdown */
#pivotSelect{
    background:#000;
    color:var(--text-white);
    border:1px solid var(--grid-line);
    padding:4px 8px;
    font-weight:bold;
}

#pivotSelect option{
    background:#000;
    color:var(--text-white);
}








.center-box{
    grid-column:2/4;
    grid-row:2/4;
    background:#000;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.6em;
    color:var(--grid-line);
    font-weight:bold;
}
</style>
</head>
<body>

<div class="controls">
    <input type="file" id="natalFile" accept=".json" style="display:none">
    <button onclick="document.getElementById('natalFile').click()">LOAD NATAL JSON</button>

    <input type="file" id="transitFile" accept=".json" style="display:none">
    <button onclick="document.getElementById('transitFile').click()">LOAD TRANSIT JSON</button>
	
	
	<label style="display:flex;align-items:center;gap:6px;font-weight:bold;">
<input type="checkbox" id="hideMinor" checked>

Hide Minor
</label>



<label style="display:flex;align-items:center;gap:6px;font-weight:bold;">
<input type="checkbox" id="hideCusps">
Hide Cusps
</label>




<label style="display:flex;align-items:center;gap:6px;font-weight:bold;">
PIVOT
<select id="pivotSelect">
<option value="ASC">ASC</option>
<option>Chandra</option>
<option>Mangala</option>
<option>Rahu</option>
<option>Jupiter</option>
<option>Saturn</option>
<option>Budha</option>
<option>Ketu</option>
<option>Venus</option>
<option>Surya</option>
<option>Chandra</option>
<option>Mangala</option>
<option>Rahu</option>
<option>Jupiter</option>
<option>Saturn</option>
<option>Budha</option>
<option>Ketu</option>
<option>Venus</option>
<option>Surya</option>
</select>
</label>





<label style="display:flex;align-items:center;gap:6px;font-weight:bold;">
HOUSE START
<select id="houseStart">
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
<option value="6">6</option>
<option value="7">7</option>
<option value="8">8</option>
<option value="9">9</option>
<option value="10">10</option>
<option value="11">11</option>
<option value="12">12</option>
</select>
</label>










</div>

<div id="chart" class="kundali"></div>

<script>
let natal = null;
let transit = null;


document.addEventListener("change",e=>{
    if(
    e.target.id==="hideMinor" ||
    e.target.id==="hideCusps" ||
    e.target.id==="pivotSelect" ||
    e.target.id==="houseStart"
) render();


});





const planets = ["Surya","Chandra","Mangala","Budha","Jupiter","Venus","Saturn","Rahu","Ketu"];

document.getElementById("natalFile").onchange = e=>{
    const r = new FileReader();
    r.onload = f=>{
        natal = JSON.parse(f.target.result);
        render();
    };
    r.readAsText(e.target.files[0]);
};

document.getElementById("transitFile").onchange = e=>{
    const r = new FileReader();
    r.onload = f=>{
        transit = JSON.parse(f.target.result);
        render();
    };
    r.readAsText(e.target.files[0]);
};

function degToText(d){
    const deg = Math.floor(d%30);
    const min = Math.floor((d%1)*60);
    return deg+"°"+min.toString().padStart(2,"0")+"′";
}

function render(){
    const k = document.getElementById("chart");
    k.innerHTML="";






		if(!natal){
		const map=[11,0,1,2,10,-1,-1,3,9,-1,-1,4,8,7,6,5];
		map.forEach(idx=>{
			const h=document.createElement("div");
			h.className="house";

			if(idx===-1){
				if(!k.querySelector(".center-box")){
					const cb=document.createElement("div");
					cb.className="center-box";
					cb.innerText="Transit Mixer";
					k.appendChild(cb);
				}
			}else{
				h.innerHTML+=`<div class="house-num">${idx+1}</div>`;
				h.innerHTML+=`<div class="cusp-line">Load Natal JSON</div>`;
				k.appendChild(h);
			}
		});
		return;
	}







    const nData = natal.ayanamshas["Lahiri"];
    const tData = transit ? transit.ayanamshas["Lahiri"] : null;

    const ascSign = Math.floor(nData.lagna/30);
	
	const pivot = document.getElementById("pivotSelect")?.value || "ASC";

	let pivotDeg = nData.lagna;

	if(pivot!=="ASC" && nData.planets[pivot]!==undefined){
		pivotDeg = nData.planets[pivot];
	}

	const pivotSign = Math.floor(pivotDeg/30);
	const houseStart = parseInt(document.getElementById("houseStart")?.value || "1");




    let chart = Array(12).fill().map(()=>[]);

    // natal asc
    // ASC handled with cusp display

    // natal planets
    planets.forEach(p=>{
    const deg = nData.planets[p];
    const s = Math.floor(deg/30);

   const isRetro = nData.planets_retro && nData.planets_retro[p];
const rMark = isRetro ? " (R)" : "";


    chart[s].push({
        text:p.substring(0,2)+" "+degToText(deg)+rMark,
        cls:"p-line"
    });
});


    // transit planets
    if(tData){
	
	const hideMinor = document.getElementById("hideMinor")?.checked;
	const minorPlanets = ["Surya","Chandra","Mangala","Budha","Venus"];


        planets.forEach(p=>{
		if(hideMinor && minorPlanets.includes(p)) return;

		const deg = tData.planets[p];
		const s = Math.floor(deg/30);

		const isRetro = tData.planets_retro && tData.planets_retro[p];
		const rMark = isRetro ? " (R)" : "";


		chart[s].push({
			text:"T-"+p.substring(0,2)+" "+degToText(deg)+rMark,
			cls:"transit-line"
		});
	});


    }

    const map=[11,0,1,2,10,-1,-1,3,9,-1,-1,4,8,7,6,5];

    map.forEach(idx=>{
        const h=document.createElement("div");
        h.className="house";

        if(idx===-1){
		h.className="house center-box";
		h.innerText="Transit Mixer";
		k.appendChild(h);
	}else{


            let houseNum=((idx-pivotSign+12)%12)+1;

			// rotate house numbering
			houseNum=((houseNum-houseStart+12)%12)+1;

            h.innerHTML+=`<div class="house-num">${houseNum}</div>`;

            

            let items = [];

			// add cusp + ASC
		const hideCusps = document.getElementById("hideCusps")?.checked;
		let cuspDeg;

		if(pivot==="ASC"){
		const realCuspIndex = ((houseNum + houseStart - 2) % 12) + 1;
		cuspDeg = nData.cusps[realCuspIndex];
	}else{
		cuspDeg = (pivotDeg + (houseNum-1)*30) % 360;
	}




		const cuspLocal = cuspDeg % 30;


		// ASC must follow rotated house start
		if(houseNum===1){
			items.push({
				text: "ASC "+degToText(cuspDeg),
				deg: cuspLocal,
				cls: "asc-line"
			});
		}


		if(!hideCusps && houseNum!==1){
		items.push({
			text: "Cusp "+houseNum+": "+degToText(cuspDeg),
			deg: cuspLocal,
			cls: "cusp-line"
		});
	}




			// add natal + transit planets
			chart[idx].forEach(p=>{
			const m = p.text.match(/(\d+)°(\d+)/);
			let dVal = 0;
			if(m){
				dVal = parseInt(m[1]) + (parseInt(m[2])/60);
			}
			items.push({
				text: p.text,
				deg: dVal,
				cls: p.cls
			});
		});






			// sorting logic
			if(idx <= 5){
				items.sort((a,b)=>a.deg-b.deg); // Aries–Virgo ascending
			}else{
				items.sort((a,b)=>b.deg-a.deg); // Libra–Pisces descending
			}

			// render
			items.forEach(it=>{
				h.innerHTML+=`<div class="p-line ${it.cls}">${it.text}</div>`;
			});






            k.appendChild(h);
        }
    });
}


render();

</script>
</body>
</html>
