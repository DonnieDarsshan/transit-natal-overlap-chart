<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Transit Mixer</title>
<style>
:root{
    --bg-gradient: linear-gradient(135deg,#1a001a,#2b0000);
    --grid-line:#ffcc00;
    --text-white:#ffffff;
    --asc-yellow:#ffcc00;
    --transit:#00e5ff;
}
body{
    background:var(--bg-gradient);
    color:var(--text-white);
    font-family:Arial,sans-serif;
    margin:0;
    padding:20px;
}



.controls{
    display:flex;
    gap:15px;
    justify-content:center;
    margin-bottom:60px; /* increase space above kundali */
}





button{
    padding:10px 20px;
    background:var(--grid-line);
    color:#000;
    border:none;
    font-weight:bold;
    cursor:pointer;
}













.kundali {
    display: grid;
    grid-template-columns: repeat(4, 1fr);

    /* FIX: force perfectly equal rows even with spanning center box */
    grid-template-rows: repeat(4, calc(650px / 4));

    width: 850px;
    height: 650px;
    min-height: 650px;


    margin: 0 auto;

    /* GRID LINES */
    gap: 2px;
    background: var(--grid-line);

    /* FIX: Use a solid border instead of box-shadow for the outer frame */
    border: 2px solid var(--grid-line);
    
    /* Ensure padding and border are included in the 650px width */
    box-sizing: border-box;
    
    /* Prevents sub-pixel rendering issues from hiding the right edge */
    overflow: hidden; 
}










.house{
    border:none;
    background:#2b0000;

    position:relative;
    display:flex;
    flex-direction:column;
    justify-content:flex-start;
    align-items:center;

    padding-top:36px;
    padding-left:8px;
    padding-right:60px;
    padding-bottom:8px;

    box-sizing:border-box;

    /* ⭐ KEY FIX — content stays inside cell */
    overflow-y:auto;
    overflow-x:hidden;
}










.house-num{
    position:absolute;
    top:6px;
    left:8px;
    color:var(--asc-yellow);
    font-weight:bold;
    font-size:24px;
    line-height:1;
}

.sav-box{
    position:absolute;
    top:6px;
    right:8px;
    background:#000;
    color:#fff;
    padding:4px 8px;
    font-size:24px;
    font-weight:bold;
    line-height:1;
    border-radius:6px;
}








.cusp-line{
    font-size:13px;
    color:#ffcc00;
    margin-bottom:4px;
    white-space:nowrap;     /* PREVENT LINE BREAK */
}

.p-line{
    font-size:18px;
    margin:2px 0;
    font-weight:bold;
    white-space:nowrap;     /* PREVENT LINE BREAK */
}













.asc-line{
    color:var(--asc-yellow);
    font-weight:bold;
}
.transit-line{
    color:var(--transit);
}



/* Dark theme for dropdowns */
#pivotSelect,
#houseStart,
#savMode{
    background:#000;
    color:var(--text-white);
    border:1px solid var(--grid-line);
    padding:4px 8px;
    font-weight:bold;
}

#pivotSelect option,
#houseStart option,
#savMode option{
    background:#000;
    color:var(--text-white);
}







.center-box{
    grid-column:2/4;
    grid-row:2/4;
    background:#000;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.6em;
    color:var(--grid-line);
    font-weight:bold;
}
</style>
</head>
<body>

<div class="controls" style="flex-direction:column;gap:10px;align-items:center;">
    <div style="display:flex;gap:15px;flex-wrap:wrap;justify-content:center;">

    <input type="file" id="natalFile" accept=".json" style="display:none">
    <button onclick="document.getElementById('natalFile').click()">LOAD NATAL JSON</button>

    <input type="file" id="transitFile" accept=".json" style="display:none">
    <button onclick="document.getElementById('transitFile').click()">LOAD TRANSIT JSON</button>
	
	




<label style="display:flex;align-items:center;gap:6px;font-weight:bold;">
<input type="checkbox" id="hideCusps">
Hide Cusps
</label>

<label style="display:flex;align-items:center;gap:6px;font-weight:bold;">
<input type="checkbox" id="hideMinorTransit" checked>
Hide Minor
</label>

<label style="display:flex;align-items:center;gap:6px;font-weight:bold;">
<input type="checkbox" id="hideRaKeTransit" checked>
Hide RaKe
</label>









<label style="display:flex;align-items:center;gap:6px;font-weight:bold;">
PIVOT
<select id="pivotSelect">
<option value="ASC">ASC</option>

<option value="Surya">Surya</option>
<option value="Chandra">Chandra</option>
<option value="Mangala">Mangala</option>
<option value="Budha">Budha</option>
<option value="Jupiter">Jupiter</option>
<option value="Venus">Venus</option>
<option value="Saturn">Saturn</option>
<option value="Rahu">Rahu</option>
<option value="Ketu">Ketu</option>

<option value="C1">Cusp 1</option>
<option value="C2">Cusp 2</option>
<option value="C3">Cusp 3</option>
<option value="C4">Cusp 4</option>
<option value="C5">Cusp 5</option>
<option value="C6">Cusp 6</option>
<option value="C7">Cusp 7</option>
<option value="C8">Cusp 8</option>
<option value="C9">Cusp 9</option>
<option value="C10">Cusp 10</option>
<option value="C11">Cusp 11</option>
<option value="C12">Cusp 12</option>
</select>
</label>





<label style="display:flex;align-items:center;gap:6px;font-weight:bold;">
HOUSE START
<select id="houseStart">
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
<option value="6">6</option>
<option value="7">7</option>
<option value="8">8</option>
<option value="9">9</option>
<option value="10">10</option>
<option value="11">11</option>
<option value="12">12</option>
</select>
</label>










    </div>




    <div style="display:flex;gap:20px;justify-content:center;align-items:center;flex-wrap:wrap;">
    <label style="display:flex;align-items:center;gap:6px;font-weight:bold;">
        <input type="checkbox" id="includeRahuSAV">
        Rahu SAV
    </label>

    <label style="display:flex;align-items:center;gap:6px;font-weight:bold;">
        <input type="checkbox" id="revertASC">
        Revert ASC
    </label>

    <label style="display:flex;align-items:center;gap:6px;font-weight:bold;">
        BAV MODE
        <select id="savMode">
            <option value="SAV">SAV</option>
            <option value="Saturn">Saturn</option>
            <option value="Jupiter">Jupiter</option>
            <option value="Lagna">Ascendant</option>
            <option value="Chandra">Chandra</option>
            <option value="Rahu">Rahu</option>
            <option value="Budha">Budha</option>
            <option value="Venus">Venus</option>
            <option value="Surya">Surya</option>
            <option value="Mangala">Mangala</option>
        </select>
    </label>
</div>

	
	
	
	
</div>





<div id="chart" class="kundali"></div>
<div id="savTable" style="width:850px;margin:40px auto 0 auto;"></div>


<script>
let natal = null;
let transit = null;


document.addEventListener("change",e=>{
    if(
    e.target.id==="hideCusps" ||
    e.target.id==="hideMinorTransit" ||
    e.target.id==="hideRaKeTransit" ||
    e.target.id==="includeRahuSAV" ||
	e.target.id==="revertASC" ||
	e.target.id==="savMode" ||
	e.target.id==="pivotSelect" ||
	e.target.id==="houseStart"

) render();

});







const planets = ["Surya","Chandra","Mangala","Budha","Jupiter","Venus","Saturn","Rahu","Ketu"];











/* ============================================================
   PARASHARA BAV RULES - VERIFIED FOR 337 TOTAL POINTS
   ============================================================ */
const BAV_RULES = {
    Surya: { 
        Surya: [1, 2, 4, 7, 8, 9, 10, 11], Chandra: [3, 6, 10, 11], 
        Mangala: [1, 2, 4, 7, 8, 9, 10, 11], Budha: [3, 5, 6, 9, 10, 11, 12], 
        Jupiter: [5, 6, 9, 11], Venus: [6, 7, 12], 
        Saturn: [1, 2, 4, 7, 8, 9, 10, 11], Lagna: [3, 4, 6, 10, 11, 12] 
    },
    Chandra: { 
			Surya: [3, 6, 7, 8, 10, 11], Chandra: [1, 3, 6, 7, 10, 11], 
			Mangala: [2, 3, 5, 6, 9, 10, 11], Budha: [1, 3, 4, 5, 7, 8, 10, 11], 
			Jupiter: [1, 4, 7, 8, 10, 11, 12], Venus: [3, 4, 5, 7, 9, 10, 11], 
			Saturn: [3, 5, 6, 11], Lagna: [3, 6, 10, 11, 12] 
    },
    Mangala: { 
        Surya: [3, 5, 6, 10, 11], Chandra: [3, 6, 11], 
        Mangala: [1, 2, 4, 7, 8, 10, 11], Budha: [3, 5, 6, 11], 
        Jupiter: [6, 10, 11, 12], Venus: [6, 8, 11, 12], 
        Saturn: [1, 4, 7, 8, 9, 10, 11], Lagna: [1, 3, 6, 10, 11] 
    },
    Budha: { 
        Surya: [5, 6, 9, 11, 12], Chandra: [2, 4, 6, 8, 10, 11], 
        Mangala: [1, 2, 4, 7, 8, 9, 10, 11], Budha: [1, 3, 5, 6, 9, 10, 11, 12], 
        Jupiter: [6, 8, 11, 12], Venus: [1, 2, 3, 4, 5, 8, 9, 11], 
        Saturn: [1, 2, 4, 7, 8, 9, 10, 11], Lagna: [1, 2, 4, 6, 8, 10, 11] 
    },
    Jupiter: { 
        Surya: [1, 2, 3, 4, 7, 8, 9, 10, 11], Chandra: [2, 5, 7, 9, 11], 
        Mangala: [1, 2, 4, 7, 8, 10, 11], Budha: [1, 2, 4, 5, 6, 9, 10, 11], 
        Jupiter: [1, 2, 3, 4, 7, 8, 10, 11], Venus: [2, 5, 6, 9, 10, 11], 
        Saturn: [3, 5, 6, 12], Lagna: [1, 2, 4, 5, 6, 7, 9, 10, 11] 
    },
    Venus: { 
        Surya: [8, 11, 12], Chandra: [1, 2, 3, 4, 5, 8, 9, 11, 12], 
		Mangala: [3, 5, 6, 9, 11, 12], Budha: [3, 5, 6, 9, 11], 
		Jupiter: [5, 8, 9, 10, 11], Venus: [1, 2, 3, 4, 5, 8, 9, 10, 11], 
		Saturn: [3, 4, 5, 8, 9, 10, 11], Lagna: [1, 2, 3, 4, 5, 8, 9] 
    },
    Saturn: { 
        Surya: [1, 2, 4, 7, 8, 10, 11], Chandra: [3, 6, 11], 
        Mangala: [3, 5, 6, 10, 11, 12], Budha: [6, 8, 9, 10, 11, 12], 
        Jupiter: [5, 6, 11, 12], Venus: [6, 11, 12], 
        Saturn: [3, 5, 6, 11], Lagna: [1, 3, 4, 6, 10, 11] 
    },
    Rahu: {
        Surya: [1,2,3,5,7,8,10],
        Chandra: [1,3,5,7,8,9,10],
        Mangala: [2,3,5,12],
        Budha: [2,4,7,8,12],
        Jupiter: [1,3,4,6,8],
        Venus: [6,7,11,12],
        Saturn: [3,5,7,10,11,12],
        Lagna: [3,4,5,9,12]
    }

	
	
	
};


function calcSAV(nData, includeRahu=false) {

    const planets7 = ["Surya", "Chandra", "Mangala", "Budha", "Jupiter", "Venus", "Saturn"];
    const posSign = {};
    
    planets7.forEach(p => posSign[p] = Math.floor(nData.planets[p] / 30));
    posSign["Lagna"] = Math.floor(nData.lagna / 30);

    const SAV = Array(12).fill(0);

    // classical 7 planet SAV
    planets7.forEach(targetPlanet => {
        const contributors = [...planets7, "Lagna"];
        contributors.forEach(source => {
            const rules = BAV_RULES[targetPlanet][source];
            const sourceSign = posSign[source];

            if (rules) {
                rules.forEach(houseOffset => {
                    const targetZodiacSign = (sourceSign + (houseOffset - 1)) % 12;
                    SAV[targetZodiacSign]++;
                });
            }
        });
    });

    // optional Rahu contribution
    if(includeRahu === true){
        const contributors = [...planets7, "Lagna"];
        contributors.forEach(source => {
            const rules = BAV_RULES["Rahu"][source];
            const sourceSign = posSign[source];

            if(rules){
                rules.forEach(offset=>{
                    const z = (sourceSign + (offset-1)) % 12;
                    SAV[z]++;
                });
            }
        });
    }

    return SAV;
}

	
	
	
	
	
	
	/* ============================================================
   SINGLE PLANET BINNA ASHTAKAVARGA
   ============================================================ */

const LAGNA_BAV_RULES_GLOBAL = {
    Surya:   [3,4,6,10,11,12],
    Chandra: [3,6,10,11,12],
    Mangala: [1,3,6,10,11],
    Budha:   [1,2,4,6,8,10,11],
    Jupiter: [1,2,4,5,6,7,9,10,11],
    Venus:   [1,2,3,4,5,8,9],
    Saturn:  [1,3,4,6,10,11],
    Lagna:   [3,6,10,11]
};

function calcSingleBAV(nData, target){

    const planets7 = ["Surya","Chandra","Mangala","Budha","Jupiter","Venus","Saturn"];

    const posSign = {};
    planets7.forEach(p=>posSign[p]=Math.floor(nData.planets[p]/30));
    posSign["Lagna"]=Math.floor(nData.lagna/30);

    const row = Array(12).fill(0);

    // Lagna special rules
    if(target==="Lagna"){
        Object.entries(LAGNA_BAV_RULES_GLOBAL).forEach(([source,rules])=>{
            const sSign = posSign[source];
            if(sSign===undefined) return;
            rules.forEach(offset=>{
                const z=(sSign+(offset-1))%12;
                row[z]++;
            });
        });
        return row;
    }

    // Rahu BAV
    if(target==="Rahu"){
        [...planets7,"Lagna"].forEach(source=>{
            const rules = BAV_RULES["Rahu"][source];
            const sSign = posSign[source];
            if(rules){
                rules.forEach(offset=>{
                    const z=(sSign+(offset-1))%12;
                    row[z]++;
                });
            }
        });
        return row;
    }

    // normal 7 planet BAV
    [...planets7,"Lagna"].forEach(source=>{
        const rules = BAV_RULES[target]?.[source];
        const sSign = posSign[source];
        if(rules){
            rules.forEach(offset=>{
                const z=(sSign+(offset-1))%12;
                row[z]++;
            });
        }
    });

    return row;
}

	
	
	










document.getElementById("natalFile").onchange = e=>{
    const r = new FileReader();
    r.onload = f=>{
        natal = JSON.parse(f.target.result);
        render();
    };
    r.readAsText(e.target.files[0]);
};

document.getElementById("transitFile").onchange = e=>{
    const r = new FileReader();
    r.onload = f=>{
        transit = JSON.parse(f.target.result);
        render();
    };
    r.readAsText(e.target.files[0]);
};

function degToText(d){
    const deg = Math.floor(d%30);
    const min = Math.floor((d%1)*60);
    return deg+"°"+min.toString().padStart(2,"0")+"′";
}

function render(){
    const k = document.getElementById("chart");
    k.innerHTML="";





if(!natal){

        const map=[11,0,1,2,10,-1,-1,3,9,-1,-1,4,8,7,6,5];

        map.forEach((idx, mapIndex)=>{
            const h=document.createElement("div");
            h.className="house";

            if(idx===-1){
                if(!k.querySelector(".center-box")){
                    const cb=document.createElement("div");
                    cb.className="center-box";
                    cb.innerText="Transit Mixer";
                    k.appendChild(cb);
                }
            }else{
                h.innerHTML+=`<div class="house-num">${idx+1}</div>`;
                h.innerHTML+=`<div class="cusp-line">Load Natal JSON</div>`;
                k.appendChild(h);
            }
        });

        /* ===== DEFAULT ROW HEIGHTS WHEN EMPTY ===== */
        
        return;
}


/* ===== LOAD NATAL + TRANSIT DATA ===== */
const nData = natal.ayanamshas["Lahiri"];
const tData = transit ? transit.ayanamshas["Lahiri"] : null;





		const ascSign = Math.floor(nData.lagna/30);
		const includeRahu = document.getElementById("includeRahuSAV")?.checked;
		const mode = document.getElementById("savMode")?.value || "SAV";

		let SAV;
		if(mode==="SAV"){
			SAV = calcSAV(nData, includeRahu);
		}else{
			SAV = calcSingleBAV(nData, mode);
		}

		const pivot = document.getElementById("pivotSelect")?.value || "ASC";

			
	
	
	let pivotDeg = nData.lagna;

	if(pivot==="ASC"){
		pivotDeg = nData.lagna;
	}
	else if(pivot.startsWith("C")){
		const cNum = parseInt(pivot.substring(1));
		pivotDeg = nData.cusps[cNum];
	}
	else if(nData.planets[pivot]!==undefined){
		pivotDeg = nData.planets[pivot];
	}

	
	
	
	

	/* ==========================================================
	   ROTATE SAV IF PIVOT IS 15°00′–29°59′ (HALF SIGN SHIFT)
	   ========================================================== */
	const pivotLocalDeg = pivotDeg % 30;

	const revertASC = document.getElementById("revertASC")?.checked;

	if(pivotLocalDeg >= 15 && !revertASC){
		const rotated = Array(12);
		for(let i=0;i<12;i++){
			rotated[(i+1)%12] = SAV[i]; // shift to next sign cyclically
		}
		SAV = rotated;
	}


	
	
	
	
	
	

	const pivotSign = Math.floor(pivotDeg/30); // zodiac reference stays fixed

	/* ==========================================================
	   HOUSE NUMBERING HALF-SIGN SHIFT (ONLY NUMBERING)
	   ========================================================== */
	let houseNumberingOffset = 0;

	if((pivotDeg % 30) >= 15 && !revertASC){
		houseNumberingOffset = 1; // next sign becomes house 1
	}



	const houseStart = parseInt(document.getElementById("houseStart")?.value || "1");











    let chart = Array(12).fill().map(()=>[]);

/* ==========================================================
   NATAL PLANETS (always shown)
   ========================================================== */
planets.forEach(p=>{
    const deg = nData.planets[p];
    const s = Math.floor(deg/30);

    const isRetro = nData.planets_retro && nData.planets_retro[p];
    const rMark = isRetro ? " (R)" : "";

    chart[s].push({
        text:p.substring(0,2)+" "+degToText(deg)+rMark,
        cls:"p-line"
    });
});

/* ==========================================================
   TRANSIT PLANETS (with hide filters)
   ========================================================== */
   if(tData){

    const hideMinor = document.getElementById("hideMinorTransit")?.checked;
    const hideRaKe = document.getElementById("hideRaKeTransit")?.checked;

    const minorTransitSet = ["Surya","Chandra","Mangala","Venus","Budha"];
    const rakeSet = ["Rahu","Ketu"];

    planets.forEach(p=>{

        if(hideMinor && minorTransitSet.includes(p)) return;
        if(hideRaKe && rakeSet.includes(p)) return;

        const deg = tData.planets[p];
        const s = Math.floor(deg/30);

        const isRetro = tData.planets_retro && tData.planets_retro[p];
        const rMark = isRetro ? " (R)" : "";

        chart[s].push({
            text:"T-"+p.substring(0,2)+" "+degToText(deg)+rMark,
            cls:"transit-line"
        });
    });
}


/* ===== ROW HEIGHT TRACKER (REQUIRED FOR DYNAMIC GRID) ===== */
let rowMaxItems = [1,1,1,1];
let cellIndex = 0;


const map=[11,0,1,2,10,-1,-1,3,9,-1,-1,4,8,7,6,5];

map.forEach((idx, mapIndex)=>{
    const h=document.createElement("div");
    h.className="house";

    if(idx===-1){
		h.className="house center-box";
		h.innerText="Transit Mixer";
		k.appendChild(h);
	}else{

            
			
			
			
			
			/* ==========================================================
		   ORIGINAL HOUSE NUMBER (FOR CUSP + ASC ONLY — NEVER SHIFT)
		   ========================================================== */
		let cuspHouseNum=((idx-pivotSign+12)%12)+1;
		cuspHouseNum=((cuspHouseNum-houseStart+12)%12)+1;

		/* ==========================================================
		   DISPLAY HOUSE NUMBER (SHIFTED WHEN ≥15°)
		   ========================================================== */
		let displayHouseNum=((idx - (pivotSign + houseNumberingOffset) + 12)%12)+1;
		displayHouseNum=((displayHouseNum-houseStart+12)%12)+1;

		h.innerHTML+=`<div class="house-num">${displayHouseNum}</div>`;
		h.innerHTML+=`<div class="sav-box">${SAV[idx]}</div>`;




            

            let items = [];
			const contentBox = document.createElement("div");
			contentBox.style.display = "flex";
			contentBox.style.flexDirection = "column";
			contentBox.style.alignItems = "flex-start";


			// add cusp + ASC
		const hideCusps = document.getElementById("hideCusps")?.checked;
		let cuspDeg;






		if(pivot==="ASC"){
		const realCuspIndex = ((cuspHouseNum + houseStart - 2) % 12) + 1;
		cuspDeg = nData.cusps[realCuspIndex];
		}else{
		cuspDeg = (pivotDeg + (cuspHouseNum-1)*30) % 360;
		}




		const cuspLocal = cuspDeg % 30;


		// ASC must follow rotated house start
		if(cuspHouseNum===1){
			items.push({
				text: "ASC "+degToText(cuspDeg),
				deg: cuspLocal,
				cls: "asc-line"
			});
		}


		if(!hideCusps && cuspHouseNum!==1){
		items.push({
			text: "Cusp "+cuspHouseNum+": "+degToText(cuspDeg),
			deg: cuspLocal,
			cls: "cusp-line"
		});
		}




			// add natal + transit planets
			chart[idx].forEach(p=>{
			const m = p.text.match(/(\d+)°(\d+)/);
			let dVal = 0;
			if(m){
				dVal = parseInt(m[1]) + (parseInt(m[2])/60);
			}
			items.push({
				text: p.text,
				deg: dVal,
				cls: p.cls
			});
		});






			// sorting logic
			if(idx <= 5){
				items.sort((a,b)=>a.deg-b.deg); // Aries–Virgo ascending
			}else{
				items.sort((a,b)=>b.deg-a.deg); // Libra–Pisces descending
			}
			
			
			
			/* measure row density */
			const row = Math.floor(mapIndex / 4);
			rowMaxItems[row] = Math.max(rowMaxItems[row], items.length);


			// render
			items.forEach(it=>{
			const d = document.createElement("div");
			d.className = "p-line " + it.cls;
			d.textContent = it.text;
			contentBox.appendChild(d);
		});

		h.appendChild(contentBox);






                        k.appendChild(h);
            cellIndex++;

         }
    });




















	/* ==========================================================
	   CONTENT-BASED ROW HEIGHT (SMART BALANCED)
	   ========================================================== */

	const TOTAL_HEIGHT = 650;
	const MIN_ROW = 95;          // minimum readable row
	const EXTRA_GAP = 18;        // 1 empty breathing line
	const HEADER_SPACE = 36;     // top header padding in house
	const LINE_HEIGHT = 22;      // approx height per text line

	/* ----------------------------------------------------------
	   1. calculate REAL required height for each row
	---------------------------------------------------------- */

	let required = rowMaxItems.map(items=>{
		const contentHeight =
			HEADER_SPACE +
			(items * LINE_HEIGHT) +
			EXTRA_GAP;
		return Math.max(contentHeight, MIN_ROW);
	});

	/* ----------------------------------------------------------
	   2. sum total required
	---------------------------------------------------------- */

	let totalRequired = required.reduce((a,b)=>a+b,0);






	/* ----------------------------------------------------------
	   3A. if extra free space → distribute evenly
	---------------------------------------------------------- */

	if(totalRequired < TOTAL_HEIGHT){

		const spare = TOTAL_HEIGHT - totalRequired;
		const addPerRow = spare / 4;

		required = required.map(h=>h + addPerRow);
	}







	/* ----------------------------------------------------------
	   3B. if overflow → compress proportionally (safe)
	---------------------------------------------------------- */

	else if(totalRequired > TOTAL_HEIGHT){

		const overflow = totalRequired - TOTAL_HEIGHT;

		const shrinkable = required.map(h=>h - MIN_ROW);
		const totalShrinkable = shrinkable.reduce((a,b)=>a+b,0);

		if(totalShrinkable > 0){
			required = required.map((h,i)=>{
				const share = (shrinkable[i]/totalShrinkable) * overflow;
				return h - share;
			});
		}
	}

	/* ----------------------------------------------------------
	   4. apply final heights
	---------------------------------------------------------- */

	k.style.gridTemplateRows =
		required.map(h=>h+"px").join(" ");
		
	renderSAVTable(nData);



	
	
	
	
	
	
}












function renderSAVTable(nData){
    const container = document.getElementById("savTable");
    container.innerHTML = "";
    if(!nData) return;

    const planets7 = ["Surya","Chandra","Mangala","Budha","Jupiter","Venus","Saturn"];

    const posSign = {};
    planets7.forEach(p=>posSign[p]=Math.floor(nData.planets[p]/30));
    posSign["Lagna"]=Math.floor(nData.lagna/30);

    const table = document.createElement("table");
    table.style.width="100%";
    table.style.borderCollapse="collapse";
    table.style.textAlign="center";
    table.style.fontSize="16px";
    table.style.background="#111";
    table.style.color="#fff";

    function td(txt,bold=false){
        const c=document.createElement("td");
        c.textContent=txt;
        c.style.border="1px solid #ffcc00";
        c.style.padding="6px";
        if(bold) c.style.fontWeight="bold";
        return c;
    }




    // header with sign names
	const signNames = [
		"Ars","Tau","Gem","Can","Leo","Vir",
		"Lib","Scp","Sag","Cap","Aqu","Pis"
	];








	const pivot = document.getElementById("pivotSelect")?.value || "ASC";
	const revertASC = document.getElementById("revertASC")?.checked;

	// get pivot degree (same logic as chart)
	
	
	let pivotDeg = nData.lagna;

	if(pivot==="ASC"){
		pivotDeg = nData.lagna;
	}
	else if(pivot.startsWith("C")){
		const cNum = parseInt(pivot.substring(1));
		pivotDeg = nData.cusps[cNum];
	}
	else if(nData.planets[pivot]!==undefined){
		pivotDeg = nData.planets[pivot];
	}

	
	
	
	
	
	
	
	
	

	const pivotSign = Math.floor(pivotDeg/30);

	// build base sign order from pivot sign
	const signOrder=[];
	for(let i=0;i<12;i++){
		signOrder.push(((pivotSign+i)%12)+1);
	}

	// half-sign shift logic (same as chart)
	let signLabelOffset = 0;
	if((pivotDeg % 30) >= 15 && !revertASC){
		signLabelOffset = 1;
	}






	// SIGN NAME ROW
	const trH=document.createElement("tr");
	trH.appendChild(td("Sign",true));
	trH.style.background="#1f2937"; // dark blue-gray

	signOrder.forEach(s=>{
    const shifted = ((s-1+signLabelOffset)%12)+1;
    const c = td(signNames[shifted-1],true);
    c.style.color="#00e5ff";
    trH.appendChild(c);
});


	trH.appendChild(td("",true));
	table.appendChild(trH);

	// HOUSE NUMBER ROW
	const trHouse=document.createElement("tr");
	trHouse.appendChild(td("House",true));
	trHouse.style.background="#3f1d2e"; // dark maroon

	for(let i=1;i<=12;i++){
		const c = td(i,true);
		c.style.color="#ffcc00";
		trHouse.appendChild(c);
	}

	trHouse.appendChild(td("",true));
	table.appendChild(trHouse);








    // calculate SAV
    let SAV = Array(12).fill(0);

    planets7.forEach(target=>{
        const row = Array(12).fill(0);

        [...planets7,"Lagna"].forEach(source=>{
            const rules = BAV_RULES[target][source];
            if(!rules) return;

            const sSign = posSign[source];

            rules.forEach(offset=>{
                const z = (sSign+(offset-1))%12;
                row[z]++;
                SAV[z]++;
            });
        });

        const tr=document.createElement("tr");
        tr.appendChild(td(target));
        let total=0;

        signOrder.forEach(sign=>{
            const v=row[sign-1];
            tr.appendChild(td(v));
            total+=v;
        });

        tr.appendChild(td(total,true));
        table.appendChild(tr);
    });

    // TOTAL row
    const trTotal=document.createElement("tr");
    trTotal.appendChild(td("Total",true));
    let grand=0;

    signOrder.forEach(sign=>{
        const v=SAV[sign-1];
        trTotal.appendChild(td(v,true));
        grand+=v;
    });

    trTotal.appendChild(td(grand,true));
    table.appendChild(trTotal);





    // LAGNA row (CUSTOM LAGNA BAV RULES — DIRECT TARGET RULES)

	const LAGNA_BAV_RULES = {
		Surya:   [3,4,6,10,11,12],
		Chandra: [3,6,10,11,12],
		Mangala: [1,3,6,10,11],
		Budha:   [1,2,4,6,8,10,11],
		Jupiter: [1,2,4,5,6,7,9,10,11],
		Venus:   [1,2,3,4,5,8,9],
		Saturn:  [1,3,4,6,10,11],
		Lagna:   [3,6,10,11]
	};

	const lagnaRow = Array(12).fill(0);
	const lagnaSign = posSign["Lagna"];

	Object.entries(LAGNA_BAV_RULES).forEach(([source, rules])=>{
		const sSign = posSign[source];
		if(sSign===undefined) return;

		rules.forEach(offset=>{
			const z=(sSign+(offset-1))%12;
			lagnaRow[z]++;
		});
	});





    const trLagna=document.createElement("tr");
    trLagna.appendChild(td("Lagna",true));
    let lagTot=0;

    signOrder.forEach(sign=>{
        const v=lagnaRow[sign-1];
        trLagna.appendChild(td(v,true));
        lagTot+=v;
    });

    trLagna.appendChild(td(lagTot,true));
    table.appendChild(trLagna);

    // RAHU row (ALWAYS ADDED)
    const rahuRow = Array(12).fill(0);

    [...planets7,"Lagna"].forEach(source=>{
        const rules = BAV_RULES["Rahu"][source];
        const sSign = posSign[source];

        if(rules){
            rules.forEach(offset=>{
                const z=(sSign+(offset-1))%12;
                rahuRow[z]++;
            });
        }
    });

    const trRahu=document.createElement("tr");
    trRahu.appendChild(td("Rahu",true));
    let rTot=0;

    signOrder.forEach(sign=>{
        const v=rahuRow[sign-1];
        trRahu.appendChild(td(v,true));
        rTot+=v;
    });

    trRahu.appendChild(td(rTot,true));
    table.appendChild(trRahu);

    container.appendChild(table);
}




render();


</script>
</body>
</html>
